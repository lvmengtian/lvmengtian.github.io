<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.24" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.161" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>MySQL常见面试题 | 浮梦札记</title><meta name="description" content=""><link rel="preload" href="/assets/style-DrEZvK8Z.css" as="style"><link rel="stylesheet" href="/assets/style-DrEZvK8Z.css"><link rel="modulepreload" href="/assets/app-DqL0oT9G.js"><link rel="modulepreload" href="/assets/index.html-D2H7bw_M.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-e1dbaae2><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-889cca3e></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-889cca3e> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-e1dbaae2 data-v-98c50ae5><div class="vp-navbar" vp-navbar data-v-98c50ae5 data-v-1eff3e5c><div class="wrapper" data-v-1eff3e5c><div class="container" data-v-1eff3e5c><div class="title" data-v-1eff3e5c><div class="vp-navbar-title has-sidebar" data-v-1eff3e5c data-v-a8561eab><a class="vp-link link no-icon title" href="/" data-v-a8561eab><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-77c293cb><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-77c293cb><!--]--><!--]--><!--]--><span data-v-a8561eab>浮梦札记</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-1eff3e5c><div class="content-body" data-v-1eff3e5c><!--[--><!--]--><div class="vp-navbar-search search" data-v-1eff3e5c><div class="search-wrapper" data-v-3c688d23><!----><div id="local-search" data-v-3c688d23><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-3c688d23><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-1eff3e5c data-v-0840a817><span id="main-nav-aria-label" class="visually-hidden" data-v-0840a817>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-0840a817 data-v-950c9576><!--[--><!----><span data-v-950c9576>首页</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/java-guide/" tabindex="0" data-v-0840a817 data-v-950c9576><!--[--><!----><span data-v-950c9576>面试指北</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/notes/" tabindex="0" data-v-0840a817 data-v-950c9576><!--[--><!----><span data-v-950c9576>笔记</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/ai/" tabindex="0" data-v-0840a817 data-v-950c9576><!--[--><!----><span data-v-950c9576>AI</span><!----><!--]--><!----></a><!--]--><!--]--></nav><!--[--><!--]--><!----><div class="vp-navbar-appearance appearance" data-v-1eff3e5c data-v-d98d8427><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-d98d8427 data-v-4421fe29 data-v-05519a3d><span class="check" data-v-05519a3d><span class="icon" data-v-05519a3d><!--[--><span class="vpi-sun sun" data-v-4421fe29></span><span class="vpi-moon moon" data-v-4421fe29></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-1eff3e5c data-v-ede9f760 data-v-2c613800><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-2c613800 data-v-dbe9afc8><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-1eff3e5c data-v-2ef44bf2 data-v-fd7634eb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-fd7634eb><span class="vpi-more-horizontal icon" data-v-fd7634eb></span></button><div class="menu" data-v-fd7634eb><div class="vp-menu" data-v-fd7634eb data-v-f00c3ea6><!----><!--[--><!--[--><!----><div class="group" data-v-2ef44bf2><div class="item appearance" data-v-2ef44bf2><p class="label" data-v-2ef44bf2>外观</p><div class="appearance-action" data-v-2ef44bf2><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-2ef44bf2 data-v-4421fe29 data-v-05519a3d><span class="check" data-v-05519a3d><span class="icon" data-v-05519a3d><!--[--><span class="vpi-sun sun" data-v-4421fe29></span><span class="vpi-moon moon" data-v-4421fe29></span><!--]--></span></span></button></div></div></div><div class="group" data-v-2ef44bf2><div class="item social-links" data-v-2ef44bf2><div class="vp-social-links social-links-list" data-v-2ef44bf2 data-v-2c613800><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-2c613800 data-v-dbe9afc8><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-1eff3e5c data-v-54c2ef6c><span class="container" data-v-54c2ef6c><span class="top" data-v-54c2ef6c></span><span class="middle" data-v-54c2ef6c></span><span class="bottom" data-v-54c2ef6c></span></span></button></div></div></div></div><div class="divider" data-v-1eff3e5c><div class="divider-line" data-v-1eff3e5c></div></div></div><!----></header><div class="vp-local-nav reached-top" data-v-e1dbaae2 data-v-734ba265><button class="menu" aria-expanded="false" aria-controls="SidebarNav" data-v-734ba265><span class="vpi-align-left menu-icon" data-v-734ba265></span><span class="menu-text" data-v-734ba265>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-734ba265 data-v-1e80eb91><button data-v-1e80eb91>返回顶部</button><!----></div></div><aside class="vp-sidebar" vp-sidebar data-v-e1dbaae2 data-v-aa9e4082><div class="curtain" data-v-aa9e4082></div><nav id="SidebarNav" class="nav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-aa9e4082><span id="sidebar-aria-label" class="visually-hidden" data-v-aa9e4082> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-5ddb9693><section class="vp-sidebar-item sidebar-item level-0 collapsible" data-v-5ddb9693 data-v-01c8a1fd><div class="item" role="button" tabindex="0" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><h2 class="text" data-v-01c8a1fd><span data-v-01c8a1fd>Java</span><!----></h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-01c8a1fd><span class="vpi-chevron-right caret-icon" data-v-01c8a1fd></span></div></div><div data-v-01c8a1fd data-v-01c8a1fd><div class="items" data-v-01c8a1fd><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-01c8a1fd data-v-01c8a1fd><div class="item" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><a class="vp-link link link" href="/java-guide/hg5e8awy/" data-v-01c8a1fd><!--[--><p class="text" data-v-01c8a1fd><span data-v-01c8a1fd>Java 基础</span><!----></p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-01c8a1fd data-v-01c8a1fd><div class="item" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><a class="vp-link link link" href="/java-guide/h9mgtev9/" data-v-01c8a1fd><!--[--><p class="text" data-v-01c8a1fd><span data-v-01c8a1fd>Java 集合</span><!----></p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-01c8a1fd data-v-01c8a1fd><div class="item" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><a class="vp-link link link" href="/java-guide/5qe4rxai/" data-v-01c8a1fd><!--[--><p class="text" data-v-01c8a1fd><span data-v-01c8a1fd>Java 并发编程</span><!----></p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-01c8a1fd data-v-01c8a1fd><div class="item" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><a class="vp-link link link" href="/java-guide/ypjcijom/" data-v-01c8a1fd><!--[--><p class="text" data-v-01c8a1fd><span data-v-01c8a1fd>Java 虚拟机</span><!----></p><!--]--><!----></a><!----></div><!----></div><!--]--></div></div></section></div><div class="no-transition group" data-v-5ddb9693><section class="vp-sidebar-item sidebar-item level-0 collapsible has-active" data-v-5ddb9693 data-v-01c8a1fd><div class="item" role="button" tabindex="0" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><h2 class="text" data-v-01c8a1fd><span data-v-01c8a1fd>数据库</span><!----></h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-01c8a1fd><span class="vpi-chevron-right caret-icon" data-v-01c8a1fd></span></div></div><div data-v-01c8a1fd data-v-01c8a1fd><div class="items" data-v-01c8a1fd><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-01c8a1fd data-v-01c8a1fd><div class="item" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><a class="vp-link link link" href="/java-guide/396o7sc3/" data-v-01c8a1fd><!--[--><p class="text" data-v-01c8a1fd><span data-v-01c8a1fd>MySQL</span><!----></p><!--]--><!----></a><!----></div><!----></div><!--]--></div></div></section></div><div class="no-transition group" data-v-5ddb9693><section class="vp-sidebar-item sidebar-item level-0 collapsible" data-v-5ddb9693 data-v-01c8a1fd><div class="item" role="button" tabindex="0" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><h2 class="text" data-v-01c8a1fd><span data-v-01c8a1fd>Spring</span><!----></h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-01c8a1fd><span class="vpi-chevron-right caret-icon" data-v-01c8a1fd></span></div></div><div data-v-01c8a1fd data-v-01c8a1fd><div class="items" data-v-01c8a1fd><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-01c8a1fd data-v-01c8a1fd><div class="item" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><a class="vp-link link link" href="/java-guide/ysb3pgbj/" data-v-01c8a1fd><!--[--><p class="text" data-v-01c8a1fd><span data-v-01c8a1fd>Spring</span><!----></p><!--]--><!----></a><!----></div><!----></div><!--]--></div></div></section></div><div class="no-transition group" data-v-5ddb9693><section class="vp-sidebar-item sidebar-item level-0 collapsible" data-v-5ddb9693 data-v-01c8a1fd><div class="item" role="button" tabindex="0" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><h2 class="text" data-v-01c8a1fd><span data-v-01c8a1fd>其他</span><!----></h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-01c8a1fd><span class="vpi-chevron-right caret-icon" data-v-01c8a1fd></span></div></div><div data-v-01c8a1fd data-v-01c8a1fd><div class="items" data-v-01c8a1fd><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-01c8a1fd data-v-01c8a1fd><div class="item" data-v-01c8a1fd><div class="indicator" data-v-01c8a1fd></div><!----><a class="vp-link link link" href="/java-guide/nkmdr64r/" data-v-01c8a1fd><!--[--><p class="text" data-v-01c8a1fd><span data-v-01c8a1fd>软技能</span><!----></p><!--]--><!----></a><!----></div><!----></div><!--]--></div></div></section></div><!--]--><!--[--><!--]--></nav></aside><!--[--><div id="VPContent" vp-content class="vp-content has-sidebar" data-v-e1dbaae2 data-v-4f97ed91><div class="vp-doc-container has-sidebar has-aside" data-v-4f97ed91 data-v-79596a8a><!--[--><!--]--><div class="container" data-v-79596a8a><div class="aside" vp-outline data-v-79596a8a><div class="aside-curtain" data-v-79596a8a></div><div class="aside-container" data-v-79596a8a><div class="aside-content" data-v-79596a8a><div class="vp-doc-aside" data-v-79596a8a data-v-95f703c6><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="vp-doc-aside-outline" role="navigation" data-v-95f703c6 data-v-937f11d8><div class="content" data-v-937f11d8><div class="outline-marker" data-v-937f11d8></div><div id="doc-outline-aria-label" aria-level="2" class="outline-title" role="heading" data-v-937f11d8><span data-v-937f11d8>此页内容</span><span class="vpi-print icon" data-v-937f11d8></span></div><ul class="root" data-v-937f11d8 data-v-8fe7a250><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-95f703c6></div><!--[--><!--]--></div></div></div></div><div class="content" data-v-79596a8a><div class="content-container" data-v-79596a8a><!--[--><!--]--><main class="main" data-v-79596a8a><nav class="vp-breadcrumb" data-v-79596a8a data-v-06b62c47><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-06b62c47><!--[--><li property="itemListElement" typeof="ListItem" data-v-06b62c47><a class="vp-link link breadcrumb" href="/" property="item" typeof="WebPage" data-v-06b62c47><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-06b62c47></span><meta property="name" content="首页" data-v-06b62c47><meta property="position" content="1" data-v-06b62c47></li><li property="itemListElement" typeof="ListItem" data-v-06b62c47><span class="vp-link breadcrumb" property="item" typeof="WebPage" data-v-06b62c47><!--[-->数据库<!--]--><!----></span><span class="vpi-chevron-right" data-v-06b62c47></span><meta property="name" content="数据库" data-v-06b62c47><meta property="position" content="2" data-v-06b62c47></li><li property="itemListElement" typeof="ListItem" data-v-06b62c47><a class="vp-link link breadcrumb current" href="/java-guide/396o7sc3/" property="item" typeof="WebPage" data-v-06b62c47><!--[-->MySQL常见面试题<!--]--><!----></a><!----><meta property="name" content="MySQL常见面试题" data-v-06b62c47><meta property="position" content="3" data-v-06b62c47></li><!--]--></ol></nav><!--[--><!--]--><!--[--><h1 class="vp-doc-title page-title" data-v-09347631><!----> MySQL常见面试题 <!----></h1><div class="vp-doc-meta" data-v-09347631><!--[--><!--]--><p class="reading-time" data-v-09347631><span class="vpi-books icon" data-v-09347631></span><span data-v-09347631>约 4456 字</span><span data-v-09347631>大约 15 分钟</span></p><!----><!--[--><!--]--><p class="create-time" data-v-09347631><span class="vpi-clock icon" data-v-09347631></span><span data-v-09347631>2025-08-21</span></p></div><!--]--><!--[--><!--]--><div class="_java-guide_396o7sc3_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-79596a8a><!--[--><!--]--><div data-v-79596a8a><h2 id="介绍数据库中的悲观锁和乐观锁" tabindex="-1"><a class="header-anchor" href="#介绍数据库中的悲观锁和乐观锁"><span>介绍数据库中的悲观锁和乐观锁</span></a></h2><h3 id="🔒-悲观锁" tabindex="-1"><a class="header-anchor" href="#🔒-悲观锁"><span>🔒 悲观锁</span></a></h3><blockquote><p>悲观锁正如其名称，比较悲观。总会认为：每当修改数据时，会有其他线程也会同时修改该数据。所以针对这种情况悲观锁的做法是：读取数据之后就加锁(eg: select...for update)，这样别的线程读取该数据的时候就需要等待当前线程释放锁，获得到锁的线程才能获得该数据的读写权限。从而保证了并发修改数据错误的问题。但是由于阻塞原因，所以导致吞吐量不高。悲观锁更适用于多写少读的情况。</p></blockquote><p><strong>场景:</strong> 同学A和同学B都要给你转500块钱(开心坏了吧，这样最终你能得到1000块钱)。</p><p><strong>使用悲观锁的流程:</strong></p><ol><li>同学A获取到你的账户余额<code>balance = 0</code>并对该条记录加锁。</li><li>同学B获取你的账户余额。由于同学A已经对这条记录加锁了，所以同学B需要等同学A转帐完成(释放锁)才能获得余额。</li><li>同学A转账完成并释放锁，此时你的账户余额<code>balance=balance + 500 = 500</code></li><li>同学B获取到你的账户余额<code>balance = 500</code>，并对该条记录加锁(如果你人缘好，此时同学C给你转账也是需要等待同学B转账完成才可以转账哦)</li><li>同学B转账完成并释放锁(如果有同学C想给你转账，此时同学C就可以获得锁并转账了)。此时你的账户余额为<code>balance = balance + 500 = 1000</code></li><li>最终你开开心心的得到了1000块钱。</li></ol><p>使用悲观锁查询的SQL示例如下，同学A获取到账号余额之后，会对该行记录进行加锁，期间其他用户阻塞等待访问该记录。所以只有等同学A的操作事务完成之后，同学B才能继续操作。</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">BEGIN</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account_id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> #{你的账户Id} </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">FOR</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> UPDATE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">UPDATE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> set</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 500</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account_id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> #{你的账户Id};</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">COMMIT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>假设转账过程没有锁，我们看看会发生什么:</strong></p><ol><li>同学A获取到你的账户余额balance_a = 0(没有加锁，此时同学B也可以获取到账户余额)</li><li>同学B获取到你的账户余额balance_b = 0</li><li>同学A转账完成，此时你的账户余额为balance = balance_a + 500 = 500</li><li>同学B转账完成，此时你的账户余额为balance = balance_b + 500 = 500</li><li>最终同学A和同学B都转了500，但是你最终只获得了500。这一定是不能接受的吧。</li></ol><p>丢失的500块去哪里了呢？从第2步可以看到同学B获取到的账户余额是0，而不是同学A转帐之后的余额500。所以问题出在这里，这是高并发场景的常见问题。所以加锁是非常必须的。但是加了悲观锁，同学都要排队给我转账，对于没有耐心的同学就直接不转帐了，我岂不是错失了发财的好机会。那有什么好办法呢？答案就是下面的乐观锁</p><h3 id="🔒-乐观锁" tabindex="-1"><a class="header-anchor" href="#🔒-乐观锁"><span>🔒 乐观锁</span></a></h3><blockquote><p>乐观锁顾名思义比较乐观，他只有在更新数据的时候才会检查这条数据是否被其他线程更新了(这点与悲观锁一样，悲观锁是在读取数据的时候就加锁了)。如果更新数据时，发现这条数据被其他线程更新了，则此次更新失败。如果数据未被其他线程更新，则更新成功。由于乐观锁没有了锁等待，提高了吞吐量，所以乐观锁适合多读少写的场景。 常见的乐观锁实现方式是：版本号version和CAS(compare and swap)。此处只介绍版本号方式。</p></blockquote><p>要采用版本号，首先需要在数据库表中新增一个字段<code>version</code>，表示此条记录的更新版本，记录每变动一次，版本号加1。依旧使用上面转账的例子说明：</p><ol><li>同学A获取到你的账户余额balance = 0和版本号version_a = 0</li><li>同学B获取到你的账户余额balance = 0和版本号version_b = 0</li><li>同学A转账完成<code>UPDATE account SET balance = #{balance}, version = version + 1 WHERE account_id=#{你的账户Id} AND version = 0</code>。(此时版本号为0，所以更新成功)</li><li>同学B转账完成<code>UPDATE account SET balance = #{balance}, version = version + 1 WHERE account_id=#{你的账户Id} AND version = 0</code>。(此时版本号为1，所以更新失败，更新失败之后同学B再转一次即可)</li><li>同学B获取到你的账户余额balance = 500和版本号version_b = 1</li><li>同学B重新转帐之后，你还是美滋滋的获得了1000。</li></ol><p>使用乐观锁查询的SQL示例如下：</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 同学A获取你的账户信息，假设此时version=0</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account_id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> #{你的账户Id}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 假设同学A的转账还未完成，同学B就发起了请求。因为此时同学A的更新未完成，所以version依然是0</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account_id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> #{你的账户Id}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 同学A转账更新操作</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">UPDATE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> SET</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 500</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account_id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#{你的账户Id}  </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">AND</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 同学B转账更新操作，此时由于同学A转账完成，DB的version变成1，所以此次更新失败</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">UPDATE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> SET</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 500</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account_id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#{你的账户Id}  </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">AND</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 同学B第二次获取你的账户信息，假设此时version=1</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account_id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> #{你的账户Id}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 同学B转账更新操作，更新成功</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">UPDATE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> SET</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">balance</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 500</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> WHERE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">account_id</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#{你的账户Id}  </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">AND</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="📌-总结" tabindex="-1"><a class="header-anchor" href="#📌-总结"><span>📌 总结</span></a></h3><ol><li>悲观锁：读取时加锁，更新完释放锁，再此过程中会造成其他线程阻塞，导致吞吐量低，适用于多写场景。</li><li>乐观锁：不加锁，只有在更新时验证数据是否被其他线程更新，吞吐量较高，适用于多读场景</li></ol><h2 id="数据库事务和隔离级别" tabindex="-1"><a class="header-anchor" href="#数据库事务和隔离级别"><span>数据库事务和隔离级别</span></a></h2><h3 id="🎤-数据库事务四大特性-acid" tabindex="-1"><a class="header-anchor" href="#🎤-数据库事务四大特性-acid"><span>🎤 数据库事务四大特性(ACID)</span></a></h3><h4 id="原子性-atomicity" tabindex="-1"><a class="header-anchor" href="#原子性-atomicity"><span>原子性(Atomicity)</span></a></h4><p>原子性是指事务中的操作要么全部成功，要么失败回滚。</p><h4 id="一致性-consistency" tabindex="-1"><a class="header-anchor" href="#一致性-consistency"><span>一致性(Consistency)</span></a></h4><p>一致性是指事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务执行之前和执行之后都必须处于一致性状态。拿转账来说，假设用户A和用户B两者的钱加起来一共是5000，那么不管A和B之间如何转账，转几次账，事务结束后两个用户的钱相加起来应该还得是5000，这就是事务的一致性。</p><h4 id="隔离性-isolation" tabindex="-1"><a class="header-anchor" href="#隔离性-isolation"><span>隔离性(Isolation)</span></a></h4><p>隔离性是指两个事务之间的操作互不影响。关于事务的隔离级别后面将会介绍。</p><h4 id="持久性-durability" tabindex="-1"><a class="header-anchor" href="#持久性-durability"><span>持久性(Durability)</span></a></h4><p>持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。</p><h3 id="🤔-隔离性会出现的问题" tabindex="-1"><a class="header-anchor" href="#🤔-隔离性会出现的问题"><span>🤔 隔离性会出现的问题</span></a></h3><p>如果不采取数据库隔离会出现以下问题：</p><h4 id="脏读" tabindex="-1"><a class="header-anchor" href="#脏读"><span>脏读</span></a></h4><p>事务A将data的值由4修改成5，但是并未提交；此时事务B读取data的值是5.但是事务A并没有提交进行了回滚，此时事务B读取的就是一个脏数据(因为此时数据库中data的数据是4不是5)。</p><h4 id="不可重复读" tabindex="-1"><a class="header-anchor" href="#不可重复读"><span>不可重复读</span></a></h4><p>不可重复读是指在对于数据库中的某个数据，一个事务范围内多次查询却返回了不同的数据值，这是由于在查询间隔，被另一个事务修改并提交了。例如事务T1在读取某一数据，而事务T2立马修改了这个数据并且提交事务给数据库，事务T1再次读取该数据就得到了不同的结果，发生了不可重复读。不可重复读和脏读的区别是，脏读是某一事务读取了另一个事务未提交的脏数据，而不可重复读则是读取了前一事务提交的数据。在某些情况下，不可重复读并不是问题，比如我们多次查询某个数据当然以最后查询得到的结果为主。但在另一些情况下就有可能发生问题，例如对于同一个数据A和B依次查询就可能不同，A和B就可能打起来了。 <strong>注：不可重复读强调的是多次查询，同样的select语句，但是2次读取的结果不一样。</strong></p><h4 id="幻读" tabindex="-1"><a class="header-anchor" href="#幻读"><span>幻读</span></a></h4><p>幻读是事务非独立执行时发生的一种现象。例如事务T1对一个表中所有的行的某个数据项做了从“1”修改为“2”的操作，这时事务T2又对这个表中插入了一行数据项，而这个数据项的数值还是为“1”并且提交给数据库。而操作事务T1的用户如果再查看刚刚修改的数据，会发现还有一行没有修改，其实这行是从事务T2中添加的，就好像产生幻觉一样，这就是发生了幻读。幻读和不可重复读都是读取了另一条已经提交的事务（这点就脏读不同），所不同的是不可重复读查询的都是同一个数据项，而幻读针对的是一批数据整体（比如数据的个数）。 <strong>注：幻读的重点在于新增或删除：同样条件的select，读取的记录不一样。</strong></p><h3 id="📌-数据库隔离级别" tabindex="-1"><a class="header-anchor" href="#📌-数据库隔离级别"><span>📌 数据库隔离级别</span></a></h3><blockquote><p>✅表示在该隔离级别下可能会存在对应的问题</p><p>❌表示在该隔离级别下不会存在对应的问题</p></blockquote><table><thead><tr><th style="text-align:center;"></th><th style="text-align:center;">脏读</th><th style="text-align:center;">不可重复读</th><th style="text-align:center;">幻读</th></tr></thead><tbody><tr><td style="text-align:center;">读未提交(read-uncommitted)</td><td style="text-align:center;">✅</td><td style="text-align:center;">✅</td><td style="text-align:center;">✅</td></tr><tr><td style="text-align:center;">读提交(read-committed)</td><td style="text-align:center;">❌</td><td style="text-align:center;">✅</td><td style="text-align:center;">✅</td></tr><tr><td style="text-align:center;">可重复度(repeatable-read)</td><td style="text-align:center;">❌</td><td style="text-align:center;">❌</td><td style="text-align:center;">✅</td></tr><tr><td style="text-align:center;">串行化(Serializable)</td><td style="text-align:center;">❌</td><td style="text-align:center;">❌</td><td style="text-align:center;">❌</td></tr></tbody></table><ul><li>串行化(Serializable)保证了完整的隔离性，是一致性最好，但是并发性最差的；</li><li>读未提交(read-uncommitted)一致性最差。</li><li>串行化、读未提交这两种在实际开发中基本不会用到。</li><li>可重复读(Repeatable-read)：是MySQL默认的隔离级别。</li><li>通过“select @@tx_isolation”查看采用的隔离级别，通过&quot;set tx_isolation=${isolation_level}&quot;设置相应的隔离级别。</li></ul><h2 id="binlog、redo-log、undo-log作用分别是什么-结构有什么区别" tabindex="-1"><a class="header-anchor" href="#binlog、redo-log、undo-log作用分别是什么-结构有什么区别"><span>binlog、redo Log、undo log作用分别是什么？结构有什么区别？</span></a></h2><h2 id="分库分表的组件-如何生成分布式id" tabindex="-1"><a class="header-anchor" href="#分库分表的组件-如何生成分布式id"><span>分库分表的组件，如何生成分布式ID？</span></a></h2><h2 id="什么是mvcc-可以解决什么问题" tabindex="-1"><a class="header-anchor" href="#什么是mvcc-可以解决什么问题"><span>什么是MVCC， 可以解决什么问题</span></a></h2><blockquote><p>想象一下，假期里你和朋友同时在看同一篇爆款笔记。你在读的时候，他‘手滑’把笔记删了。请问：你应该看到他删除后的结果吗？还是应该继续安心读完？ 数据库每天都在处理海量这样的‘并发访问’冲突。而 **MVCC (Multi-Version Concurrency Control) **，就是让数据库既能保证你读数据时不被阻塞，又能保证你朋友删数据时不报错的神奇机制！</p></blockquote><h3 id="🔍-白话核心概念" tabindex="-1"><a class="header-anchor" href="#🔍-白话核心概念"><span>🔍 白话核心概念</span></a></h3><p><strong>MVCC是什么？</strong><strong>多版本并发控制</strong>。通俗讲，就是数据库<strong>为了同一行数据保留了多个历史版本</strong>。当不同的事务来读写这行数据时，数据库会根据规则给它分配合适的版本，让它们像在‘不同的时空’里操作一样，互不干扰。</p><p><strong>它解决了什么核心问题？</strong></p><ol><li><strong>解决<code>脏读</code>、<code>不可重复读</code>问题</strong>：通过版本控制，一个事务只能读到在它开始之前就已经提交的数据版本。</li><li><strong>提高并发性能</strong>：<strong>读不阻塞写，写不阻塞读</strong>。这是MVCC带来的最大性能优势，避免了大量的锁等待。</li></ol><h3 id="🎤-图解mvcc" tabindex="-1"><a class="header-anchor" href="#🎤-图解mvcc"><span>🎤 图解MVCC</span></a></h3><p><strong>MVCC的两大核心“道具”：</strong></p><ol><li><p><strong>隐式字段</strong>：</p><ul><li><code>DB_TRX_ID</code> (6字节)：记录最近一次<strong>更新</strong>这行数据的事务ID。</li><li><code>DB_ROLL_PTR</code> (7字节)：<strong>回滚指针</strong>，指向这条记录的上一个历史版本（存储在Undo Log里）。</li><li><code>DB_ROW_ID</code> (6字节)：隐含的自增ID（如果没有主键）。</li><li>还有一个删除标记位。</li></ul></li><li><p><strong>Read View（读视图）</strong>：</p><ul><li>这是事务进行<strong>快照读</strong>（普通SELECT）时产生的“一致性视图”。</li><li>它决定了当前事务能看到哪个版本的数据。</li><li>它包含几个关键ID： <ul><li><code>m_ids</code>: 生成Read View时，系统中<strong>活跃</strong>（未提交）的事务ID集合。</li><li><code>min_trx_id</code>: <code>m_ids</code>中的最小值。</li><li><code>max_trx_id</code>: 生成Read View时，系统应该分配给下一个事务的ID。</li><li><code>creator_trx_id</code>: 创建这个Read View的事务ID。</li></ul></li></ul></li></ol><p><strong>MVCC的工作流程</strong></p><p>我们通过下面的流程图，来展示MVCC如何通过<code>Read View</code>和<code>Undo Log</code>来决定一个事务应该看到哪个版本的数据： <img src="/images/mvcc_flow.png" alt=""></p><h3 id="🌰-场景示例" tabindex="-1"><a class="header-anchor" href="#🌰-场景示例"><span>🌰 场景示例</span></a></h3><p><strong>场景：</strong> 事务A和事务B并发执行。</p><ol><li>事务A (ID=50) 开始，查询一条数据<code>balance=100</code>。</li><li>事务B (ID=60) 开始，将<code>balance</code>更新为<code>200</code>并<strong>提交</strong>。</li><li>事务A再次查询<code>balance</code>。</li></ol><p><strong>问：事务A第二次查询到的值是多少？</strong></p><p><strong>答：</strong></p><ul><li>如果事务隔离级别是 <strong><code>REPEATABLE READ</code> (可重复读)</strong>：事务A<strong>仍然看到100</strong>。因为它在第一次查询时就生成了一个Read View，之后一直使用这个视图，所以看不到事务B提交的修改。<strong>这就解决了‘不可重复读’。</strong></li><li>如果事务隔离级别是 <strong><code>READ COMMITTED</code> (读已提交)</strong>：事务A<strong>会看到200</strong>。因为它在每次查询时都会生成一个新的Read View，所以能看到最新已提交的数据。</li></ul><h2 id="mysql索引失效的场景" tabindex="-1"><a class="header-anchor" href="#mysql索引失效的场景"><span>MySQL索引失效的场景</span></a></h2><blockquote><p>平时是不是遇到过明明加了索引，查询还是慢得像蜗牛？很可能是你的索引‘失灵’了！今天我们就来盘点那些导致索引失效的经典场景，附上实战示例，让你彻底搞懂</p></blockquote><p>在深入细节之前，我们可以通过一张图来建立一个整体的认知。下图概括了最常见的索引失效场景及其核心原因： <img src="/images/sql_index_invalid.png" alt=""></p><p>接下来，我们来逐一剖析这些场景的具体表现。</p><p><strong>1. 违背最左前缀原则 (The Leftmost Prefix Rule)</strong></p><p>这是联合索引最常见的坑。</p><ul><li><strong>示例：</strong> 我们有一个联合索引 <code>INDEX idx_name_age (name, age)</code>。<div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【有效✅】使用了索引的最左列`name`</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">小毛</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【有效✅】使用了索引的最左列`name`，并且包含`age`</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">小毛</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> AND</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> age </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 25</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【失效❌】没有从最左列`name`开始，跳过了它</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> age </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 25</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【部分有效】使用了最左列`name`，但因为是范围查询，`age`列无法用索引进一步筛选</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">小毛</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> AND</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> age </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 20</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>2. 在索引列上使用函数或计算</strong></p><p>一旦对索引列进行操作，MySQL就无法直接使用该索引的排序结构了。</p><ul><li><strong>示例：</strong> 在<code>create_time</code>、 <code>age</code> 列上有索引。<div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【失效❌】对索引列使用了函数</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> YEAR</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(create_time) </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2023</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【有效✅】改为范围查询，避免对列操作</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> create_time </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">BETWEEN</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2023-01-01</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> AND</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2023-12-31</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【失效❌】对索引列进行了计算</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> age </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【有效✅】将计算移到等号另一边</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> age </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 29</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>3. 隐式类型转换 (Implicit Type Conversion)</strong></p><p>如果字符串类型的索引列，你传入了一个数字，MySQL会进行隐式转换，相当于在列上使用了函数。</p><ul><li><strong>示例：</strong> <code>user_id</code> 是 <code>VARCHAR</code> 类型，并且有索引。<div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【失效❌】数据库需要将每个user_id转换成数字，才能与123比较，相当于使用了CAST函数</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> user_id </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 123</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【有效✅】传入字符串，类型匹配</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> user_id </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">123</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>4. 使用不等于 (!= 或 &lt;&gt;)</strong></p><p>不等于条件无法直接利用索引的有序性来快速定位数据，通常会导致全表扫描。</p><ul><li><strong>示例：</strong> 在 <code>age</code> 列上有索引。<div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【失效❌】不等于查询，需要检查所有行</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> age </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 25</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> age </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&gt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 25</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>5. 使用 <code>LIKE</code> 以通配符开头</strong></p><p>索引是按照字段值的前缀排序的。以 <code>%</code> 开头，意味着没有确定的前缀，索引无法定位。</p><ul><li><strong>示例：</strong> 在 <code>name</code> 列上有索引。<div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【失效❌】以通配符开头，索引不知道从哪找起</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> LIKE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">%毛</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【有效✅】确定的前缀，索引可以快速定位</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> LIKE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">小%</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>6. 使用 <code>OR</code> 连接非索引列</strong></p><p>如果 <code>OR</code> 前后的条件并非都基于索引，MySQL通常会选择全表扫描。</p><ul><li><strong>示例：</strong> 只在 <code>name</code> 列上有索引，<code>age</code> 列没有。<div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【失效❌】`age`列无索引，导致整个查询无法有效使用索引</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> users </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">小毛</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> OR</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> age </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 25</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【解决方案】可以考虑将`age`也加上索引，或使用UNION改写。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>7. 数据库评估使用全表扫描更快时</strong></p><p>如果表非常小，或者查询需要返回表中很大比例的数据（例如超过30%），MySQL优化器可能认为直接读取整个表（全表扫描）比“索引查找+回表”的代价更小，从而放弃使用索引。</p><ul><li><strong>示例：</strong> 在 <code>status</code> 列（只有0，1两种状态）上有索引。<div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">-- 【可能失效】当status=1的数据占全表40%时，优化器可能选择全表扫描</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">EXPLAIN </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">SELECT</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> orders </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WHERE</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> status</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-79596a8a data-v-132f89cc><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-132f89cc><span class="contributors-label" data-v-132f89cc>贡献者: </span><span class="contributors-info" data-v-132f89cc><!--[--><!--[--><span class="contributor" data-v-132f89cc>lvmengtian</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-132f89cc><div class="pager" data-v-132f89cc><a class="vp-link link pager-link prev" href="/java-guide/ypjcijom/" data-v-132f89cc><!--[--><span class="desc" data-v-132f89cc>上一页</span><span class="title" data-v-132f89cc>Java 虚拟机</span><!--]--><!----></a></div><div class="pager" data-v-132f89cc><a class="vp-link link pager-link next" href="/java-guide/ysb3pgbj/" data-v-132f89cc><!--[--><span class="desc" data-v-132f89cc>下一页</span><span class="title" data-v-132f89cc>Spring</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-e1dbaae2 style="display:none;" data-v-64659f34><span class="percent" data-allow-mismatch data-v-64659f34>0%</span><span class="show icon vpi-back-to-top" data-v-64659f34></span><svg aria-hidden="true" data-v-64659f34><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-64659f34></circle></svg></button><footer class="vp-footer has-sidebar" vp-footer data-v-e1dbaae2 data-v-cbcd6b75><!--[--><div class="container" data-v-cbcd6b75><p class="message" data-v-cbcd6b75>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></p><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-DqL0oT9G.js" defer></script></body></html>